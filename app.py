from flask import Flask, send_file, request, jsonify
from flask_cors import CORS
import pandas as pd
import numpy as np
import matplotlib.pyplot as plt
import seaborn as sns
import io
import base64
import logging
import matplotlib
matplotlib.use('Agg')  # GUI backend yerine Agg kullan

app = Flask(__name__)
CORS(app)  # T√ºm originlere izin ver

logging.basicConfig(level=logging.DEBUG)

@app.route('/')
def index():
    return send_file('index.html')

@app.route('/health')
def health_check():
    return jsonify({'status': 'ok'})

@app.route('/analyze', methods=['POST'])
def analyze():
    try:
        app.logger.info("\n=== Analysis Starting ===")
        
        # Request body'sini al ve DataFrame olu≈ütur
        data = request.get_json(force=True)
        df = pd.DataFrame(data)
        app.logger.info(f"DataFrame created: {df.shape}")
        
        # Veri tiplerini d√∂n√º≈üt√ºr
        df['transaction_qty'] = pd.to_numeric(df['transaction_qty'], errors='coerce')
        df['unit_price'] = df['unit_price'].str.replace(',', '.').astype(float)
        
        # Total sales hesapla (en ba≈üta)
        df["total_sales"] = df["transaction_qty"] * df["unit_price"]
        
        plots = []
        
        try:
            # ABC Analysis (√∂nce ABC analizi)
            app.logger.info("ABC Analysis starting...")
            
            # ABC analizi i√ßin grupla
            df_abc = df.groupby("product_detail")["total_sales"].sum().reset_index()
            df_abc = df_abc.sort_values(by="total_sales", ascending=False)
            df_abc["cumulative_percentage"] = df_abc["total_sales"].cumsum() / df_abc["total_sales"].sum() * 100
            
            # ABC kategorilerini belirle
            def classify_abc(percentage):
                if percentage <= 70: return "A"
                elif percentage <= 90: return "B"
                else: return "C"
            
            df_abc["ABC_Category"] = df_abc["cumulative_percentage"].apply(classify_abc)
            
            # ABC grafiƒüi olu≈ütur
            plt.figure(figsize=(10, 6))
            sns.countplot(data=df_abc, x="ABC_Category", hue="ABC_Category", palette="coolwarm", legend=False)
            plt.title("ABC Analysis: Product Classification")
            plt.xlabel("ABC Category")
            plt.ylabel("Count of Products")
            
            # Grafiƒüi kaydet
            plots.append({
                'image': fig_to_base64(plt.gcf()),
                'title': 'ABC Analysis',
                'description': (
                    "üìä Product Classification Summary:\n"
                    f"üìå Category A: {len(df_abc[df_abc.ABC_Category=='A'])} products - High value items\n"
                    f"üìå Category B: {len(df_abc[df_abc.ABC_Category=='B'])} products - Medium value items\n"
                    f"üìå Category C: {len(df_abc[df_abc.ABC_Category=='C'])} products - Low value items\n"
                    "\nüìà Recommendations:\n"
                    "‚Ä¢ Focus inventory control on Category A items\n"
                    "‚Ä¢ Implement periodic review for Category B items\n"
                    "‚Ä¢ Use simplified control for Category C items"
                )
            })
            plt.close()
            
            app.logger.info("ABC Analysis completed")
            
        except Exception as e:
            app.logger.error(f"ABC Analysis error: {str(e)}")
            
        try:
            # Stok Analizi (ABC analizinden sonra)
            app.logger.info("Stock Analysis starting...")
            
            # Her √ºr√ºn i√ßin son 7 g√ºnl√ºk satƒ±≈ü trendini hesapla
            df['datetime'] = pd.to_datetime(df['transaction_date'].astype(str))
            last_week = df['datetime'].max() - pd.Timedelta(days=7)
            
            df_stock = df[df['datetime'] > last_week].groupby('product_detail').agg({
                'transaction_qty': ['sum', 'mean', 'count'],
                'total_sales': ['sum', 'mean']
            }).reset_index()
            
            df_stock.columns = ['product_detail', 'weekly_qty', 'avg_daily_qty', 'transaction_count', 'weekly_sales', 'avg_daily_sales']
            
            # Kritik stok seviyesini belirle (g√ºnl√ºk ortalama satƒ±≈üƒ±n 3 katƒ±)
            df_stock['critical_stock'] = df_stock['avg_daily_qty'] * 3
            
            # A ve B kategorisindeki √ºr√ºnleri filtrele
            critical_products = df_stock[
                (df_stock['product_detail'].isin(df_abc[df_abc['ABC_Category'].isin(['A', 'B'])]['product_detail'])) &
                (df_stock['weekly_qty'] > 0)
            ].sort_values('weekly_sales', ascending=False)
            
            # Top 10 kritik √ºr√ºn√º g√∂rselle≈ütir
            plt.figure(figsize=(12, 6))
            sns.barplot(
                data=critical_products.head(10),
                x='weekly_qty',
                y='product_detail',
                palette='YlOrRd'
            )
            plt.title('Critical Stock Levels (Last 7 Days)')
            plt.xlabel('Weekly Sales Quantity')
            plt.ylabel('Product')
            
            # Uyarƒ± mesajƒ±nƒ± olu≈ütur
            warning_msg = (
                "‚ö†Ô∏è Critical Stock Alert\n\n"
                "üìä Top Priority Items:\n"
            )
            for _, row in critical_products.head(10).iterrows():
                warning_msg += (
                    f"\nüîç {row['product_detail']}\n"
                    f"   ‚Ä¢ Weekly Sales Volume: {row['weekly_qty']:.0f} units\n"
                    f"   ‚Ä¢ Average Daily Sales: {row['avg_daily_qty']:.1f} units\n"
                    f"   ‚Ä¢ Recommended Stock Level: {row['critical_stock']:.0f} units\n"
                    f"   ‚Ä¢ Action Required: Immediate reorder\n"
                )
            
            # Grafiƒüi kaydet
            plots.append({
                'image': fig_to_base64(plt.gcf()),
                'title': 'Stock Analysis and Order Recommendations',
                'description': warning_msg
            })
            plt.close()
            
            app.logger.info("Stock Analysis completed")
            
        except Exception as e:
            app.logger.error(f"Stock Analysis error: {str(e)}")
            
        try:
            # FRM Analysis
            app.logger.info("FRM Analysis starting...")
            
            # Datetime s√ºtununu olu≈ütur
            df["datetime"] = pd.to_datetime(df["transaction_date"].astype(str) + " " + df["transaction_time"])
            reference_datetime = df["datetime"].max() + pd.Timedelta(minutes=1)
            
            # FRM metriklerini hesapla
            df_frm = df.groupby("store_id").agg(
                Recency=("datetime", lambda x: (reference_datetime - x.max()).total_seconds() / 60),
                Frequency=("transaction_id", "count"),
                Monetary=("total_sales", "sum")
            ).reset_index()
            
            # FRM grafiƒüi
            plt.figure(figsize=(10, 6))
            sns.scatterplot(data=df_frm, x="Recency", y="Monetary", size="Frequency", sizes=(20, 200))
            plt.title("FRM Analysis: Customer Segmentation")
            plt.xlabel("Recency (Minutes)")
            plt.ylabel("Monetary Value")
            
            # Grafiƒüi kaydet
            plots.append({
                'image': fig_to_base64(plt.gcf()),
                'title': 'FRM Analysis',
                'description': (
                    "üìä Store Performance Metrics:\n\n"
                    f"‚è±Ô∏è Recency\n"
                    f"   ‚Ä¢ Average: {df_frm.Recency.mean():.1f} minutes\n"
                    f"   ‚Ä¢ Best: {df_frm.Recency.min():.1f} minutes\n\n"
                    f"üîÑ Frequency\n"
                    f"   ‚Ä¢ Average visits: {df_frm.Frequency.mean():.1f}\n"
                    f"   ‚Ä¢ Highest: {df_frm.Frequency.max():.0f}\n\n"
                    f"üí∞ Monetary\n"
                    f"   ‚Ä¢ Average spend: ${df_frm.Monetary.mean():.2f}\n"
                    f"   ‚Ä¢ Highest spend: ${df_frm.Monetary.max():.2f}"
                )
            })
            plt.close()
            
            app.logger.info("FRM Analysis completed")
            
        except Exception as e:
            app.logger.error(f"FRM Analysis error: {str(e)}")
            
        try:
            # Stok Durumu Analizi
            app.logger.info("Stock Status Analysis starting...")
            
            # Son 30 g√ºnl√ºk satƒ±≈ü trendini hesapla
            last_month = df['datetime'].max() - pd.Timedelta(days=30)
            df_last_month = df[df['datetime'] > last_month]
            
            # √úr√ºn bazƒ±nda satƒ±≈ü istatistikleri
            df_stock_status = df_last_month.groupby('product_detail').agg({
                'transaction_qty': ['sum', 'mean', 'std'],
                'total_sales': 'sum'
            }).reset_index()
            
            # S√ºtun isimlerini d√ºzenle
            df_stock_status.columns = ['product_detail', 'monthly_qty', 'daily_avg', 'daily_std', 'monthly_sales']
            
            # G√ºvenlik stok seviyesi hesapla (2 sigma - %95 g√ºven aralƒ±ƒüƒ±)
            df_stock_status['safety_stock'] = (df_stock_status['daily_avg'] + 2 * df_stock_status['daily_std']) * 7  # 1 haftalƒ±k
            
            # Kritik √ºr√ºnleri belirle (A ve B kategorisi √ºr√ºnlerinden)
            critical_items = df_stock_status[
                df_stock_status['product_detail'].isin(
                    df_abc[df_abc['ABC_Category'].isin(['A', 'B'])]['product_detail']
                )
            ].sort_values('monthly_sales', ascending=False)
            
            # En kritik 15 √ºr√ºn√º g√∂rselle≈ütir
            plt.figure(figsize=(12, 8))
            sns.barplot(
                data=critical_items.head(15),
                x='monthly_qty',
                y='product_detail',
                palette='RdYlGn_r'  # Kƒ±rmƒ±zƒ±-Sarƒ±-Ye≈üil renk paleti (tersten)
            )
            plt.title('Kritik Stok Durumu (Son 30 G√ºn)')
            plt.xlabel('Aylƒ±k Satƒ±≈ü Miktarƒ±')
            plt.ylabel('√úr√ºn')
            
            # Detaylƒ± stok raporu olu≈ütur
            stock_report = (
                "üìä Inventory Status Report\n\n"
                "üö® Critical Items Requiring Attention:\n"
            )
            
            for _, row in critical_items.head(15).iterrows():
                safety_level = row['safety_stock']
                current_level = row['monthly_qty'] / 30
                
                if current_level < safety_level:
                    risk_level = "‚ö†Ô∏è HIGH RISK" if current_level < safety_level/2 else "‚ö° MEDIUM RISK"
                    stock_report += (
                        f"\n{risk_level} {row['product_detail']}\n"
                        f"   ‚Ä¢ Daily Sales: {row['daily_avg']:.1f} units\n"
                        f"   ‚Ä¢ Safety Stock: {safety_level:.0f} units\n"
                        f"   ‚Ä¢ Monthly Volume: {row['monthly_qty']:.0f} units\n"
                        f"   ‚Ä¢ Revenue Impact: ${row['monthly_sales']:.2f}\n"
                    )
            
            # Grafiƒüi kaydet
            plots.append({
                'image': fig_to_base64(plt.gcf()),
                'title': 'Stock Status Analysis',
                'description': stock_report
            })
            plt.close()
            
            app.logger.info("Stock Status Analysis completed")
            
        except Exception as e:
            app.logger.error(f"Stock Status Analysis error: {str(e)}")
            
        # Sonu√ß d√∂nd√ºr
        return jsonify({
            'status': 'success',
            'message': 'Analysis completed',
            'data_shape': df.shape,
            'plots': plots
        })

    except Exception as e:
        app.logger.error(f"ERROR: {str(e)}")
        import traceback
        app.logger.error(traceback.format_exc())
        return jsonify({'error': str(e)}), 500

def fig_to_base64(fig):
    img = io.BytesIO()
    fig.savefig(img, format='png', bbox_inches='tight')
    img.seek(0)
    return base64.b64encode(img.getvalue()).decode()

if __name__ == '__main__':
    app.run(host='0.0.0.0', port=5001, debug=True)